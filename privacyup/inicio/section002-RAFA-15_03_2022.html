<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 col-sm-10 offset-sm-1 col-md-10 offset-md-1 col-lg-10 offset-lg-1 col-xl-10 offset-xl-1">
            <h1>Será que sua empresa precisa se adaptar a LGPD?</h1>
            <p>Responda nosso quiz para descobrir.</p>
            <a href="#" class="btn btn-tertiary shadow-none" data-bs-toggle="modal" data-bs-target="#quizStart">
                <i class="bi bi-quora"></i> Quiz
            </a>
        </div>
    </div>
</div>
<div class="modal fade show" tabindex="-1" aria-labelledby="quizStart" id="quizStart"
    style="padding-right: 17px; display: block;" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="bi bi-x-square"></i> Close
                </button>
                <div class="row">
                    <div
                        class="col-xs-12 col-sm-10 offset-sm-1 col-md-10 offset-md-1 col-lg-10 offset-lg-1 col-xl-10 offset-xl-1 grid-top">
                        <h1>Quiz</h1>
                        <p>Texto de introdução ao quiz!</p>
                    </div>
                    <div
                        class="col-xs-12 col-sm-10 offset-sm-1 col-md-10 offset-md-1 col-lg-10 offset-lg-1 col-xl-10 offset-xl-1 grid-middle">
                        <div class="card quiz-start" style="display: block;">
                            <button class="btn btn-primary shadow-none next" onclick="next()">
                                <i class="bi bi-arrow-down-circle"></i> Começar!
                            </button>
                        </div>

                        <div class="card quiz-question">
                            <h2>Q1 Question 1?</h2>
                            <div><input type="radio" name="q1" data-correct="true">Sim</div>
                            <div><input type="radio" name="q1">Não</div>
                        </div>

                        <div class="card quiz-question">
                            <h2>Q2 Question 2?</h2>
                            <div><input type="radio" name="q2" data-correct="true">Sim</div>
                            <div><input type="radio" name="q2">Não</div>
                            <button class="btn btn-primary shadow-none next">Voltar</button>
                        </div>

                        <div class="card quiz-question">
                            <h2>Q3 Question 3?</h2>
                            <div><input type="radio" name="q3" data-correct="true">Sim</div>
                            <div><input type="radio" name="q3">Não</div>
                            <button class="btn btn-primary shadow-none next">Voltar</button>
                        </div>

                        <form class="card quiz-form">
                            <h2>Resultado
                                <hr>
                            </h2>

                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name="userName" placeholder="*Seu Nome"
                                    required="" oninvalid="this.setCustomValidity('Por favor inserir seu nome')"
                                    oninput="setCustomValidity('')" spellcheck="false" data-ms-editor="true">
                                <label for="floatingInput">*Seu Nome</label>
                            </div>

                            <div class="row">
                                <div class="col-md">
                                    <div class="form-floating mb-3">
                                        <input type="email" class="form-control" name="userEmail"
                                            placeholder="*Seu email" required=""
                                            oninvalid="this.setCustomValidity('Por favor inserir seu e-mail')"
                                            oninput="setCustomValidity('')">
                                        <label for="floatingInput">*Seu email</label>
                                    </div>
                                </div>
                                <div class="col-md">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" name="userPhone"
                                            placeholder="*Número para contato" required=""
                                            oninvalid="this.setCustomValidity('Por favor inserir seu número para contato')"
                                            oninput="setCustomValidity('')" spellcheck="false" data-ms-editor="true">
                                        <label for="floatingPassword">*Número para contato</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name="userCompanySector"
                                    placeholder="*Setor da sua empresa" required=""
                                    oninvalid="this.setCustomValidity('Por favor inserir o setor da sua empresa')"
                                    oninput="setCustomValidity('')">
                                <label for="floatingInput">*Setor da sua empresa</label>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" name="usersNumbersEmployees"
                                    placeholder="*Número de funcionários" required=""
                                    oninvalid="this.setCustomValidity('Por favor inserir o número de funcionários')"
                                    oninput="setCustomValidity('')" spellcheck="false" data-ms-editor="true">
                                <label for="floatingPassword">*Número de funcionários</label>
                            </div>

                            <div class="form-floating mb-3">
                                <textarea class="form-control" name="userMessage" placeholder="Deixe sua mensagem aqui."
                                    style="height:150px" required=""
                                    oninvalid="this.setCustomValidity('Digite sua mensagem')"
                                    oninput="setCustomValidity('')" spellcheck="false" data-ms-editor="true"></textarea>
                                <label for="floatingTextarea">Deixe sua mensagem aqui.</label>
                            </div>

                            <button type="button" class="btn btn-primary shadow-none next"
                                onclick="prev()">Voltar</button>
                            <button type="submit" class="btn btn-primary shadow-none next">
                                <i class="bi bi-arrow-down-circle"></i> Resultado!
                            </button>
                        </form>

                        <style>
                            .card.quiz-question div {
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                gap: .5rem;
                                padding: .5rem;
                            }

                            .card.quiz-question button {
                                margin: 1rem 0 0 0;
                            }

                            .card.quiz-question h2 {
                                font-size: 1.2rem;
                            }
                        </style>
                        <script>
                            const _ = e => document.querySelector(e) || false
                            const _a = e => document.querySelectorAll(e) || false
                            const next = () => {
                                qId++
                                _('.card.quiz-form').style.display = qId > qC.length - 1 ? 'block' : 'none'

                                qC.forEach(e => e.style.display = 'none')
                                if (qId > qC.length - 1) return

                                if (qId > qC.length - 1) qId = qC.length - 1
                                _('.card.quiz-start').style.display = 'none'

                                qC[qId].style.display = 'block'
                            }
                            let qId = -1,
                                qC = _a('.card.quiz-question')

                            _a('.card input[type=radio]').forEach(e => e.onclick = next)
                            _a('.card.quiz-question button').forEach(e => e.onclick = prev)
                            _('.card.quiz-form').onsubmit = e => {
                                e.preventDefault()
                                result()
                            }

                            // displaying the first block of question
                            _('.card.quiz-start').style.display = "block";

                            function prev() {
                                qId--
                                _('.card.quiz-form').style.display = qId > qC.length - 1 ? 'block' : 'none'

                                qC.forEach(e => e.style.display = 'none')
                                if (qId < -1) return
                                if (qId < 0) qId = 0
                                qC[qId].style.display = 'block'
                            }

                            //getting final result
                            function result() {
                                console.log('result')
                                let score = 0
                                let questions = []

                                qC.forEach(q => {
                                    questions.push({
                                        pergunta: q.querySelector('h2').innerHTML,
                                        resposta: q.querySelector('input:checked').parentElement.innerText,
                                        correct: q.querySelector('input[data-correct="true"]').parentElement.innerText
                                    })
                                    if (q.querySelector('input:checked').parentElement.innerText == q.querySelector('input[data-correct="true"]').parentElement.innerText) score++
                                })

                                let url = "../api/sendQuizMail.php"
                                let data = {
                                    userName: _('[name=userName]').value,
                                    userEmail: _('[name=userEmail]').value,
                                    userPhone: _('[name=userPhone]').value,
                                    userCompanySector: _('[name=userCompanySector]').value,
                                    usersNumbersEmployees: _('[name=usersNumbersEmployees]').value,
                                    userMessage: _('[name=userMessage]').value,
                                    score: score,
                                    questions: JSON.stringify(questions)
                                }

                                let form = new FormData()
                                for (var i in data) {
                                    form.set(i, data[i])
                                }

                                let opt = {
                                    method: 'post',
                                    headers: new Headers(),
                                    mode: 'cors',
                                    cache: 'default',
                                    body: form
                                }

                                // Sending ...
                                fetch(url, opt).then(r => r.json()).then(d => {
                                    if (d.redirect) window.location.href = d.redirect
                                    alert(d.message)
                                })
                            }
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>